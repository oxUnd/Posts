<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous">
  <link href="https://www.orrafy.com/css/reset.css?v=57015ef" rel="stylesheet">
  <link href="https://www.orrafy.com/css/site.css?v=57015ef" rel="stylesheet">
  <link rel="preload" href="https://www.orrafy.com/fonts/blockzone-webfont.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="stylesheet" href="//unpkg.com/heti/umd/heti.min.css">
  
</head>
<body>
  <header id="preamble" class="status heti heti--classic">
    <div class="logo">
      <a href="/">
        <img src="https://0.gravatar.com/avatar/6187fb849f337554f1515012aedd06d55365e8ac6f170cbadfaaf94d5e3790cd?s=80" class="avatar" alt="My icon."/>
      </a>
      <a href="/"><h2>OxUnd. </h2></a>
      <div id="social">
        <a title="dmacvicar on Github" href="https://github.com/oxund">
          <i id="github-icon" class="fa-brands fa-github"></i>
      	</a>
        <a title="RSS feed" id="atom" href="https://www.orrafy.com/posts/rss.xml">
          <i id="rss-icon" class="fa-solid fa-rss"></i>
        </a>
    </div>
 </header>
 <main id="main">
 
<article class="heti heti--classic">
  <h1>&#34;Markdown Helper，一次 Mac App 开发之旅&#34;</h1>
  <div class="date">22 Sep 2015</div>
  <div class="content">
    
<section id="outline-container-2015-09-22-create-mac-app" class="outline-2">
<h2 id="2015-09-22-create-mac-app">2015-09-22-create-mac-app</h2>
<div class="outline-text-2">
<blockquote>
<p>
使用 XCode 7 开发，使用操作系统 OSX 10.11
</p>
</blockquote>

<p>
最近由于经常写文档，想找个顺手的工具，但很多 Markdown
工具都没有处理图片的问题。大概有这么三类
</p>

<ol class="org-ol">
<li value="0">图片只能用远端的</li>
<li>图片可以引入本地路径</li>
<li>图片可以上传</li>
</ol>

<p>
第 1 种是那些不支持本地图片的，这类工具很多，DayOne
就是其中一个，当然你可能会说它能传*一张*图片。
</p>

<p>
第 2 种像 write
或者用编辑器都可以做到，可惜的是传到远端的时候还得考虑图片路径映射的问题
</p>

<p>
第 3 种一般都是远端应用或者 chrome
的插件，唯一的缺点是写文字时颤抖，容易引起不适。
</p>

<p>
而能做到把图片处理的得当的即好用的工具没能发现（至少我没有发现）；
</p>

<p>
从上面描述来看论实用性还是得选择图片传到远端，引入时引入图片的
URL，这样所有的编辑器下都可以很方便的使用。
</p>

<p>
其实，我们有自己喜欢的编辑文档（Markdown）的方法，比如用 sublime text
或者 vim。只要有个工具能搞定图片这个事情就皆大欢喜了。
</p>

<p>
从这点出发，我只需要一个开速上传图片并且返回图片 URL
的小工具就能满足需求。当然你也许会说直接传到图床（这是放毛片用的好吧）或者网盘不就行了。但这个路径还是太长，太麻烦。
</p>

<p>
我给这个工具取名叫 感叹号（Exclamation Mark），因为 Markdown
语法加一个图片的第一个字符是 =!=。
</p>

<p>
在开始的时候可能我需要做一些技术选型，由于自己使用的是 OS
X，毫无疑问直接开发原生程序可以给我带来很大的便利性，比如可以方便的访问剪切板，实现剪切复制黏贴很方便。不过，我没有开发过
Mac 应用，也让我纠结了一番，想着要不要用
<a href="https://github.com/atom/electron">electron</a>
来实现，后来还是选择了使用原生开发。
</p>

<p>
由于我需要这样一个工具而且我没有开发过 Mac
下的应用，一下子就激起了我的兴趣，我用周末时间，边看别人写的代码边实现整个应用程序的基本功能搞定了。
</p>

<p>
这个工具有两部分，服务端和客户端部分，服务端就相对于比较简单的，期初直接用
PHP 自己写了个 router
相对于优雅的搞定了功能，接受文件后保存返回文件的访问 url。
</p>

<p>
最折腾的地方在客户端，由于以前也没学过，好在对 C
语言比较熟，再加上强大的 Google，很快我的客户端慢慢的堆砌完成了。
</p>

<p>
在这个过程中也有一些需要记录下来的东西。
</p>

<p>
我的客户端设计有两个窗口，主窗口、设置窗口。主窗口包含触发上传文件的按钮和显示区域，设置窗口设置服务器接收端信息（想着后续可能会有人感兴趣自己搭建服务使用）；
</p>

<p>
其中几个需要攻克的技术点
</p>

<ul class="org-ul">
<li>打开一个文件浏览器窗口，选择文件，并获取选到文件的信息</li>
<li>模拟上传（一般用 POST 请求上传）</li>
<li>新建另一个窗口，主窗口可以控制它</li>
<li>设置的接收端数据进行永久保存</li>
<li>设置 App 的图标</li>
</ul>
</div>

<div id="outline-container-打开一个文件浏览窗口选择文件" class="outline-4">
<h4 id="打开一个文件浏览窗口选择文件">打开一个文件浏览窗口，选择文件</h4>
<div class="outline-text-4" id="text-打开一个文件浏览窗口选择文件">
<p>
接口
<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/ApplicationKit/Classes/NSOpenPanel_Class/">NSOpenPanel</a>
实现这个操作
</p>

<div class="org-src-container">
<pre class="src src-objc"><span class="org-type">NSOpenPanel</span> *<span class="org-variable-name">panel</span> = [NSOpenPanel openPanel];
[panel setCanChooseFiles: <span class="org-constant">YES</span>]; <span class="org-comment-delimiter">//</span><span class="org-comment">&#26159;&#21542;&#33021;&#36873;&#25321;&#25991;&#20214;
</span>[panel setCanCreateDirectories: <span class="org-constant">NO</span>]; <span class="org-comment-delimiter">// </span><span class="org-comment">&#26159;&#21542;&#21019;&#24314;&#25991;&#20214;&#22841;
</span>[panel setCanChooseDirectories: <span class="org-constant">NO</span>]; <span class="org-comment-delimiter">// </span><span class="org-comment">&#26159;&#21542;&#33021;&#36873;&#25321;&#25991;&#20214;&#22841;
</span>[panel setAllowedFileTypes:@[@<span class="org-string">"jpg"</span>, @<span class="org-string">"jpeg"</span>, @<span class="org-string">"png"</span>, @<span class="org-string">"gif"</span>]]; <span class="org-comment-delimiter">// </span><span class="org-comment">&#33021;&#35775;&#38382;&#30340;&#25991;&#20214;&#21518;&#32512;</span>
</pre>
</div>

<p>
初始化好了对象，就执行以下接口打开文件浏览窗口进行选择文件。
</p>

<div class="org-src-container">
<pre class="src src-objc">[panel beginSheetModalForWindow: [[<span class="org-keyword">self</span> view] window] completionHandler: ^(NSInteger result) {
        <span class="org-keyword">if</span> (result == NSFileHandlingPanelOKButton) {
                onComplete([panel URLs][0]);
        }
}]; 
</pre>
</div>

<p>
这个接口算是异步接口，当成功后会调用给定的回调函数 =onComplete=。
当然你也可以调用同步接口；
</p>

<div class="org-src-container">
<pre class="src src-objc"><span class="org-type">NSInteger</span> <span class="org-variable-name">result</span> = [panel runModal];
<span class="org-keyword">if</span> (result == NSFileHandlingPanelOKButton) {
    <span class="org-keyword">return</span> [panel URLs][0];
}
</pre>
</div>

<p>
当然建议使用异步接口，不然会卡顿一下。上面代码中有这样的语句
</p>

<div class="org-src-container">
<pre class="src src-objc">[panel URLs][0];
</pre>
</div>

<p>
这个应该是高版本才开始支持的，对于 <code>NSArray</code> 使用这种方式访问，也算是
Objc 的一种进步，当然后续可能全都使用 swift 了，不过还是建议学习一下
Objc，可以使用积攒已久的开源财富。
</p>

<div class="org-src-container">
<pre class="src src-objc">^() {
  <span class="org-comment-delimiter">//</span><span class="org-comment">balabala
</span>}
</pre>
</div>

<p>
<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/Blocks/Articles/bxGettingStarted.html">blocks</a>
在 C 语言里可以使用函数指针来实现传参一个函数，这是 Objc
里面另一种类似实现。
</p>
</div>
</div>

<div id="outline-container-模拟上传" class="outline-4">
<h4 id="模拟上传">模拟上传</h4>
<div class="outline-text-4" id="text-模拟上传">
<p>
模拟上传也就是模拟一次表单提交，这个就很简单的，一搜一大把，包括各种语言版本的都有。网络请求使用的类是
<a href="https://developer.apple.com/library/ios/documentation/Foundation/Reference/NSURLSession_class/">NSURLSession</a>，<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSMutableURLRequest_Class/">NSMutableURLRequest</a>；
</p>

<p>
打开一个 HTTP
请求，并发送数据，数据完成后执行回调（当然得用异步，不然拖死主进程）。
</p>

<div class="org-src-container">
<pre class="src src-objc"><span class="org-type">NSURLSession</span> *<span class="org-variable-name">session</span> = [NSURLSession sharedSession];
<span class="org-type">NSURLSessionDataTask</span> *<span class="org-variable-name">reqTask</span> = [session dataTaskWithRequest:req completionHandler:onReady];
[reqTask resume];
</pre>
</div>

<p>
接口 <code>dataTaskWithRequest</code> 接口接受一个 Request
对象，以及一个网络请求成功后的回调 =completionHandler=。
</p>

<p>
那么实例化 <code>NSMutableURLRequest</code> 得到一个 Request 对象。
</p>

<p>
<a href="https://gist.github.com/xiangshouding/34cb19f177a7a998b5f6">代码</a>
</p>

<p>
调用的回调函数 <code>onReady</code> 函数结构是
</p>

<div class="org-src-container">
<pre class="src src-objc"><span class="org-type">void</span> (^onReady) (<span class="org-type">NSData</span> *<span class="org-variable-name">data</span>, <span class="org-type">NSURLResponse</span> *<span class="org-variable-name">res</span>, <span class="org-type">NSError</span> *<span class="org-variable-name">err</span>) {}
</pre>
</div>

<p>
很自然，第一个参数是访问服务端得到的数据，第二个是 Response
对象，第三个是错误；当我们想拿到服务器返回的状态码时需要实例化
=NSHTTPURLResponse=，可能看 API 文档的时候会无从下手，其实作为 C
语言高级版本，数据类型是可以通过强转来实现的变更的，因为最终都是一块连续的内存。
</p>

<div class="org-src-container">
<pre class="src src-objc"><span class="org-type">NSHTTPURLResponse</span> *<span class="org-variable-name">response</span> = (<span class="org-type">NSHTTPURLResponse</span> *) res;
<span class="org-type">long</span> <span class="org-variable-name">statusCode</span> = [response statusCode]; <span class="org-comment-delimiter">// </span><span class="org-comment">&#33719;&#21462;&#21040;&#26381;&#21153;&#22120;&#36820;&#22238;&#29366;&#24577;&#30721;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-新建另一个窗口" class="outline-4">
<h4 id="新建另一个窗口">新建另一个窗口</h4>
<div class="outline-text-4" id="text-新建另一个窗口">
<p>
这个可能比较简单，新建一个 <code>xib</code> 文件（View），然后实现一个 Controller
类关联即可，具体方法可以参考网络，一大把一大把的文档。
</p>

<p>
需要给大家推荐一个新建 Perferences 窗口的类库
<a href="https://github.com/shpakovski/MASPreferences">https://github.com/shpakovski/MASPreferences</a> 实现得特别赞，直接拿来用。
</p>

<p>
还有包管理工具 <a href="https://cocoapods.org">https://cocoapods.org</a>
</p>
</div>
</div>

<div id="outline-container-设置数据永久保存" class="outline-4">
<h4 id="设置数据永久保存">设置数据永久保存</h4>
<div class="outline-text-4" id="text-设置数据永久保存">
<p>
用户提交的配置信息，可以用
<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSUserDefaults_Class/">NSUserDefaults</a>
实现。
</p>

<div class="org-src-container">
<pre class="src src-objc"><span class="org-type">NSUserDefaults</span> * <span class="org-variable-name">userDefaults</span> = [NSUserDefaults standardUserDefaults];
[userDefaults setObject: @<span class="org-string">"xxx"</span> forKey: @<span class="org-string">"username"</span>];
<span class="org-type">NSString</span> *<span class="org-variable-name">username</span> = [userDefaults stringForKey: @<span class="org-string">"username"</span>];
<span class="org-comment-delimiter">// </span><span class="org-comment">xxx</span>
</pre>
</div>

<p>
还有其他若干类型接口，可逐一参考文档。
</p>
</div>
</div>

<div id="outline-container-设置-app-的图标" class="outline-4">
<h4 id="设置-app-的图标">设置 App 的图标</h4>
<div class="outline-text-4" id="text-设置-app-的图标">
<p>
这个其实蛮折腾的，需要制作 icon 图片，并且生成 <code>.icns</code>
文件。好在有现成的工具制作，无需那么麻烦去保存多个分辨率的图片然后调用命令生成。推荐一个免费的在线制作工具
<a href="https://iconverticons.com/online">https://iconverticons.com/online</a> 。
</p>

<p>
把生成的 <code>.icns</code> 放到项目中，并修改 <code>info.plist</code> 中 <code>Icon File</code> 为
<code>.icns</code> 文件的名字即可。
</p>

<p>
举例；
</p>

<pre class="example" id="org3bfae49">
appicon.icns
</pre>

<p>
<a href="http://store.orrafy.com/get/uuid=81c2b68ffe8b1d6f7f7cf8aafdfbe9be">http://store.orrafy.com/get/uuid=81c2b68ffe8b1d6f7f7cf8aafdfbe9be</a>
</p>

<p>
顺便展示一下我弄的 icon
</p>

<p>
<a href="http://store.orrafy.com/get/uuid=737280894969a0139d65ee82d400ff9a">http://store.orrafy.com/get/uuid=737280894969a0139d65ee82d400ff9a</a>
</p>

<p>
回过头来，发现 Mac
应用的开发还是蛮有意思的，后续可能会花更多来开发一些有意思的应用程序。
</p>

<p>
我选择的语言是 Objective-c，后续转投 swift。
</p>
</div>
</div>
</section>

  </div>
</article>

 </main>

<hr/>
 
 <p class='disclaimer'></p>

  <p>Last updated 30 Nov 2025. Built with <a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.4 (<a href="https://orgmode.org/">Org</a> mode 9.6.15). <a href="https://www.orrafy.com/readme.html">Details</a>.</p>
  <script src="//unpkg.com/heti/umd/heti-addon.min.js"></script>
  <script>
    const heti = new Heti('.heti');
    heti.autoSpacing();
  </script>
</body>
</html>
