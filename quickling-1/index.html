<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta name="description" content="Personal blog of Berk Özbalcı, about computers, math and music">
      <meta name="author" content="orrafy">
      <meta name="viewport" content="width=device-width">
      <link rel="stylesheet" href="/css/syntax.css">
      <link rel="stylesheet" href="/css/main.css">
      <link rel="stylesheet" href="/css/normalize.css">
      <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
      <link rel="icon" href="/favicon.ico" type="image/x-icon">
      <link rel="alternate" type="application/atom+xml" href="/atom.xml">
      <title>加快网页加载的方案：bigpipe，bigrender，lazyrender</title>
      <meta name="twitter:card" content="summary">
      <meta name="twitter:site" content="@shouding">
   </head>
   
   <body>
      <main>
         <header>
            <h1 class="title"><a href="/">:)</a></h1>
         </header>

         <article>
   <h2>加快网页加载的方案：bigpipe，bigrender，lazyrender</h2>
   <p>开篇之初需要介绍一些网站页面加载的各种性能优化手段，他们分别是<code>bigrender</code>、<code>bigpipe</code>、<code>lazyrender</code>。</p>

<ul>
<li><code>bigrender</code> 一种减少首屏dom节点优化首屏展现的方案；</li>
<li><code>bigpipe</code>  一种通过chunk输出来优化网页展现的方案；</li>
<li><code>quickling</code> 一种加载页面的模式，页面的一个局部可以通过异步请求，请求数据包括渲染好的页面以及静态资源；</li>
<li><code>lazyrender</code> 手机上可能网络传输很慢，如果先传输一部分过来展示，然后再根据用户的操作输出剩下的部分，无疑是可以提高首屏时间的。整个方案就命名为<code>lazyrender</code></li>
</ul>

<h3>bigrender</h3>

<p>详细说一下bigrender如何实现的，一个页面可能占几屏，首先出现在用户视野里的自然是第一屏。一次渲染如果把所有都渲染，无疑需要比较长的时间，这时候用户无法操作界面甚至于无法看到页面。bigrender的思路是这样的；</p>

<ul>
<li>先渲染首屏，其余的部分的html被放到注释里面（或<code>textarea</code>），这样就保证不被渲染，较少首屏时间。</li>
<li>当用户向下查看次屏的内容时，再触发脚本渲染次屏的内容。</li>
<li>依次展现整个网页</li>
</ul>

<h3>bigpipe</h3>

<p>bigpipe对服务器要求比较高，需要支持chunk输出。其实就是在同一个链接上将一个页面分段输出。需要服务器端能并行处理页面，假设页面可以分为三屏，没屏都对应一些数据。当某一屏的数据获取成功，其可以马上返回给浏览器（也就是pipe的方式输出），这样对应的屏就展现出来了。如果支持并行处理，再以chunk的方式输出，无疑会让浏览器加载展现会快很多。</p>

<p>对于上面说的举个例子；假设页面分为三部分A，B，C，A的数据是调用后端服务层<code>api_a</code>得到，B是<code>api_b</code>，C是<code>api_c</code>。</p>

<p><em>node.js示例</em></p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">asyncMap</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;slide&#39;</span><span class="p">).</span><span class="nx">asyncMap</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//并行处理</span>
    <span class="nx">asyncMap</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">&quot;http://api.xxx.com/api_a&quot;</span><span class="p">,</span>
            <span class="s2">&quot;http://api.xxx.com/api_b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;http://api.xxx.com/api_c&quot;</span>
        <span class="p">],</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                <span class="nx">r</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span> <span class="nx">d</span> <span class="o">+=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span> <span class="p">});</span>
                <span class="nx">r</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span> <span class="c1">//直接输出</span>
                    <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">},</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
        <span class="p">};</span>
    <span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</code></pre></div>
<p>上面就是一个并行化的例子，当然了如果不是api调用，查询数据库也是同样的道理。</p>

<p>可能会有这样的疑问，如何精准控制页面的展现。比如可能第二屏先出来，导致用户看到的是第二屏，而第一屏跑到了第二屏下面；其实这个已经有成型的解决方案了，比如facebook，微博等都实现了bigpipe。</p>

<p>解决上面问题的大致思路是，先给浏览器吐一个结构。</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;html&gt;</span>
    ...
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;first&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;second&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
    ...
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>然后在html结束后，输出一些js代码来渲染内容上去；比如</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;html&gt;</span>
    ...
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;first&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;second&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
    ...
<span class="nt">&lt;/html&gt;</span>
<span class="nt">&lt;script&gt;</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="cm">/*first内容*/</span><span class="p">});</span><span class="nt">&lt;/script&gt;</span> <span class="c">&lt;!-- 第一次chunk --&gt;</span>
<span class="nt">&lt;script&gt;</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="cm">/*second内容*/</span><span class="p">});</span><span class="nt">&lt;/script&gt;</span> <span class="c">&lt;!-- 第二次chunk --&gt;</span>
</code></pre></div>
<p>这样就完美搞定页面渲染的问题，并且提升了不少性能，一个部分一个部分渲染的嘛~</p>

<h3>lazyrender</h3>

<p>在手机网络下，html如果太大，会传输很长时间。这时候如果把页面拆解为几部分然后分块请求，将有利于页面的展示。当然了，如果后端比较龟速，分成几块也可以使用相同的方式去加快页面的展现。</p>

<p>lazyrender就是这个思路。大概做法就是，当页面渲染的时候，把首屏先传输给浏览器进行展示，其他屏或者不重要的东西给页面打一段js。大概是这个样子的；</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;html&gt;</span>
    ...
    <span class="nt">&lt;div&gt;</span>首屏代码<span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;script&gt;</span><span class="nx">lazyrender</span><span class="p">(</span><span class="s1">&#39;second&#39;</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
    ...
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>当首屏展现完成后，可以触发次屏的加载。使用quickling的方式加载次屏的html，css，js等然后进行渲染。</p>

<h3>总结</h3>

<p>这些方案解释就那么回事儿，但是实现起来确实比较麻烦。好在去年实现了一套支持bigrender，lazyrender的解决方案。</p>

<ul>
<li><a href="https://github.com/xiangshouding/bigpipe.smarty">https://github.com/xiangshouding/bigpipe.smarty</a></li>
</ul>

<p><em>各种环境问题导致不支持pipe输出</em></p>

</article>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'feeddly'; // required: replace example with your foshortn
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscr>comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="ldisqus">Disqus</span></a>

<footer>
   <div id="date" class="meta">
      31 May 2014
   </div>
   <div id="return">
      <a href="/">&laquo; Return to the home page</a>
   </div>
</footer>

      </main>
      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51065914-1', 'orrafy.com');
  ga('send', 'pageview');

</script>
   </body>
</html>
