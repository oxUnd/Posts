<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta name="description" content="Personal blog of Berk Özbalcı, about computers, math and music">
      <meta name="author" content="orrafy">
      <meta name="viewport" content="width=device-width">
      <link rel="stylesheet" href="/css/syntax.css">
      <link rel="stylesheet" href="/css/main.css">
      <link rel="stylesheet" href="/css/normalize.css">
      <link rel="stylesheet" href="/css/css/font-awesome.min.css">
      <!--[if IE 7]>
        <link rel="stylesheet" href="/css/css/font-awesome-ie7.min.css">
      <![endif]-->
      <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
      <link rel="icon" href="/favicon.ico" type="image/x-icon">
      <link rel="alternate" type="application/atom+xml" href="/atom.xml">
      <title>用nodejs构建网站</title>
      <meta name="twitter:card" content="summary">
      <meta name="twitter:site" content="@shouding">
   </head>
   
   <body>
      <main>
         <header>
            <h1 class="title"><a href="/">:)</a></h1>
         </header>

         <article>
   <h2>用nodejs构建网站</h2>
   <hr />
   <h3>用node.js构建网站</h3>

<p>node.js灵活，轻巧，异步IO这些都是被大家传道的优点。不过在我看来，其后面庞大的社区才是最闪亮的。社区很庞大，以至于实现什么东西，扒拉扒拉就能搞定。所以这次node.js构建网站也出现在了现在的研究课题里面。</p>

<p>构建网站，开发其次，其实最主要的还是线上的运维。这块如果不搞好实在只能算是个玩具。不过好在现在有很多的管理nodejs进程的工具。比如<code>pm2</code>、<code>forever</code>等。还需要一套容灾方案。比如服务挂了，起不起来了怎么办等等等。</p>

<p>so，在这篇文章里罗列一下用什么手段在用nodejs构建网站时能防止灾难性的问题发生。</p>

<p>文章从以下几个方面进行；</p>

<ul>
<li>一个健壮的框架</li>
<li>一个靠谱的部署方案</li>
<li>一套完善的监控</li>
<li>一套完善的降级方案</li>
</ul>

<h4>健壮的框架</h4>

<p>想想框架能为整个项目带来什么？是好用的helper工具，还是结构清晰的目录结构抑或是强壮的错误处理能力？纵观现在能看到的那些框架，解决的问题无非是路由映射（跟目录结构息息相关），提供了很多公共库库（方便开发），基本上围绕着开发来的。其实用nodejs也需要一个这样的库。说到这些大家可能已经想到了<code>express</code>。</p>

<p>对，就是<code>express</code>。</p>

<p>不过在我看来<code>express</code>还是有点问题，如果裸用它就显得太灵活了，所以业界最广泛的一种使用方式是在其上在封装一个框架，一个典型的包括<code>model</code>、<code>controller</code>、<code>view</code>的MVC框架。比如现在我比较喜欢的paypal的 http://krakenjs.com/ ，一个分层分的很明晰的MVC框架。</p>

<p>那我们的做法也是一样的，也是基于<code>express</code>进行封装。然后再支持牛逼哄哄的<code>bigpipe</code>。算是一个健壮的框架就产生了。至于如何支持<code>bigpipe</code>后续会发篇博文说明。</p>

<p><em>框架的好处</em></p>

<ul>
<li>一致的目录结构，增强可维护性</li>
<li>一致的公共库，避免出现组件库打架的事情，增强维护性</li>
<li>一致的路由，增强实用性</li>
<li>....</li>
</ul>

<hr>

<ul>
<li>路由</li>
<li>目录结构</li>
<li>MVC</li>
<li>bigpipe</li>
</ul>

<hr>

<h4>靠谱的部署方案</h4>

<p>其实单拉出部署是因为，不像php那样，把php代码扔到对应的目录就能跑起来。node.js是需要重新启动node服务的。如果上线不频繁也没啥，但是如果上线频繁，总不能一天断好几次服务。所以需要一个靠谱的部署方案。</p>

<p>期间俺们的同学经过多次的验证和靠谱的推论。用一个<code>recluster</code>的东东来做这个事情。recluster是这么搞定这个事情的。当某个链接正在被某进程处理时，这时候如果有新代码上线，需要restart服务。在这种情况下，它先启动新的进程。然后等在那些还在做处理的老进程，等完成后杀死它们。如果没有在处理状态的老进程，则直接杀死。把新的请求都发给新启动的进程。这样就是一种名字叫<code>热启动</code>的模式了。</p>

<p>如果你要用nodejs上线，<code>recluster</code>你值得拥有。</p>

<p>https://github.com/doxout/recluster</p>

<p>这个是关于上线启动服务的，但如果恰巧服务器有多台服务器，则需要在本地找好一台同构的机器，编译node。上线时打包上线更靠谱一点。至于编译node，再简单不过了。</p>

<p>还有负载均衡，这块就用node自带<code>cluster</code>就挺好。</p>

<hr>

<ul>
<li>上线、部署、热启动</li>
<li>负载均衡</li>
</ul>

<hr>

<h4>完善的监控</h4>

<p>从测试的结果来看，node的应用程序的内存时及其容易飙升的。所以内存上升报警这块需要做好预案，哪怕是杀掉进程重启也行。</p>

<p>好在node使用的v8提供了不错的一些方法来达到这个目的。这块后续也会出一篇文章详细探讨。</p>

<p>还有一些问题比如，node程序错误了要抓取错误等，记录日志让监控平台抓取分析等等等，一些线上监控还是得需要很完善的。</p>

<hr>

<ul>
<li>内存监控</li>
<li>爆栈重启</li>
<li>错误报警</li>
</ul>

<hr>

<h4>完善的降级方案</h4>

<p>如果是成年老站，在使用node这么个新款时，不得不考虑如果node挂掉。切换到老站上面的策略。</p>

<p>现在一致的做法是，在php/java等机器上nginx把需要node处理的数据都代理给node机器处理。一旦node机器出问题，则把这些流量切回本机。这个方案估计是一个长态方案，一直要node稳定。</p>

<hr>

<ul>
<li>容灾</li>
<li>降级</li>
</ul>

<hr>

</article>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'feeddly'; // required: replace example with your foshortn
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscr>comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="ldisqus">Disqus</span></a>

<footer>
   <div id="date" class="meta">
      13 Jun 2014
   </div>
   <div id="return">
      <a href="/">&laquo; Return to the home page</a>
   </div>
</footer>

      </main>
      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51065914-1', 'orrafy.com');
  ga('send', 'pageview');

</script>
   </body>
</html>
